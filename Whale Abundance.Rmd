---
title: "MT5751: Distance Sampling Project"
author: "Group K"
date: "`r Sys.Date()`"
output:
  pdf_document:
    highlight: tango
fontsize: 12pt
---

\begin{center}

xxx, 180015716, 220013309

\end{center}
\

```{r Libraries and Logo, fig.align='center', message=FALSE, echo = FALSE, warning=FALSE, echox=FALSE, out.width='0.50\\linewidth'}
library(tidyverse)
library(knitr)
include_graphics("STA.png")
```

\newpage 

\tableofcontents 

\newpage

### Abstract

### Introduction

### Methods

**Data Collection**

**Data Analysis**
\
Due to an obscured view close to the transect line, detections were left-truncated at 100m Rekdal et al. (2015).
\
8 models were fit to the distance data using all combinations of hazard-rate and half-normal detection functions with cosine, hermite polynomial and simple polynomial adjustments. Model selection using Akaike information criterion (AIC) found that the best model was a half-normal with no adjustments (see figure 1). AICc was also applied due to the ratio of model parameters to observation being less than 1:40 and found the same result (Takezawa, 2014). This model had an good fit; Cramer-von Mises test (T = 0.073, p = 0.732), bootstrap Kolmogorov-Smirnov test for goodness-of-fit (D = 0.073, p = 1). Additionally a QQ-plot comparing empirical and fitted CDF had points lying approximately on the 1:1 line (see figure 1).

```{r, Model Fit Plot, echo = FALSE, warning = FALSE, results = 'hide', message = FALSE}

# Set up packages 
library(Distance)
library(tidyverse)
library(remotes)

# Getting Package Statsecol from github which contains the data
remotes::install_github("https://github.com/chrissuthy/statsecol")

# Loading in the data package
library(statsecol)
# Half-normal with no adjustment 
hn <- ds(data = bowhead_LT, 
         key = 'hn', 
         adjustment = NULL ) 

# Setting plot size
par(mfrow=c(1,2), mar = c(5, 4, 4, 2) + 0.1, oma=c(2, 3, 5, 2))

# Plotting the detection function over the distances distribution
plot(hn, 
     which=2, 
     pl.col = adjustcolor("seagreen",0.5), 
     border = NULL,
     ylab = "Detection probability (g(x))", 
     xlab = "Distance", 
     las=1,
     main = "A")

# Plotting and running the Cramer-von Mises test

gof_ds(hn, main = 'B')
subtitle = ('Figure 1: Half-Normal No Adjustment Model Fit. A is the model fit over the distribution \nof distances. B is the QQ-plot of the expected vs observed CDF')

mtext(side=1, adj=0, cex=0.7, subtitle, outer = TRUE)

``` 

### Results

### Discussion

### References

### Appendix

R Analysis Code
```{r Setting up, eval = FALSE}
#####    SETTING UP    #####

# Set up packages 
library(Distance)
library(tidyverse)
library(remotes)


# Getting Package Statsecol from github which contains the data
remotes::install_github("https://github.com/chrissuthy/statsecol")

# Loading in the data package
library(statsecol)

```

```{r Exploratory Analysis, echo = FALSE}
#####    EXPLORATORY ANALYSIS    #####

# look at data columns
str(bowhead_LT)

# Looking at the distribution of the distances


par(mfrow=c(1,1), 
    mar = c(5, 4, 4, 2) + 0.1) # Setting up the plot size
hist(bowhead_LT$distance, 
     xlab="Distance (km)",  # Naming x-axis
     ylab = 'Number of Bowhead Whales',  # Naming y axis
     main = "Distances of Bowhead Whales from Line Transects", # Naming plot
     col = adjustcolor("seagreen", 0.5), # Changing colour and intensity of bars
     las = 1) # Changing orientation of x-axis tick labels

```

```{r Modelling, eval = FALSE}
#####     MODELLING     #####

# Due to the long shoulder seen in the histogram, first fit a hazard rate;
    #then fit a half-normal


# Fitting hazard-rate detection functions with all adjustment terms 

# Hazard-rate with no adjustment 
hr <- ds(data = bowhead_LT, 
         key = 'hr', 
         adjustment = NULL ) 

# Hazard-rate with a cosine adjustment 
hr_cos <- ds(data = bowhead_LT, 
             key = 'hr', 
             adjustment = 'cos')

# Hazard-rate with a hermite polynomial adjustment 
hr_herm <- ds(data = bowhead_LT, 
              key = 'hr', 
              adjustment = 'herm' )

# Hazard-rate with a simple polynomial adjustment 
hr_poly <- ds(data = bowhead_LT, 
              key = 'hr', 
              adjustment = 'poly' ) 



# Fitting half-normal detection functions with all adjustment terms 

# Half-normal with no adjustment 
hn <- ds(data = bowhead_LT, 
         key = 'hn', 
         adjustment = NULL ) 

# Half-normal with a cosine adjustment
hn_cos <- ds(data = bowhead_LT, 
             key = 'hn', 
             adjustment = 'cos' ) 

# Half-normal with a hermite polynomial adjustment
hn_herm <- ds(data = bowhead_LT, 
              key = 'hn', 
              adjustment = 'herm' )

# Half-normal with a simple polynomial adjustment
hn_poly <- ds(data = bowhead_LT, 
              key = 'hn', 
              adjustment = 'poly' )
```

```{r Model Selection, eval = FALSE}
#####     MODEL SELECTION     #####

# Comparing Models graphically by fit of detection probability over distance distribution

# Half-normal detection function over histogram plot
par(mfrow = c(2, 2), 
    mar = c(5, 4, 4, 2) + 0.1) # Setting up plot size and margins

# Plotting all 4 half-normal models
plot(hn, main = "no adjustment") 
plot(hn_cos, main = "cosine")
plot(hn_poly, main = "polynomial")
plot(hn_herm, main = "hermite polynomial")
title("Half-Normal Models", 
      line = -1, 
      outer = TRUE) # Naming title and setting location


# Hazard-rate Detection function over histogram plot
par(mfrow = c(2, 2), 
    mar = c(5, 4, 4, 2) + 0.1) # Setting up plot size and margins

# Plotting all 4 hazard-rate models
plot(hr, main = "no adjustment")
plot(hr_cos, main = "cosine")
plot(hr_poly, main = "polynomial")
plot(hr_herm, main = "hermite polynomial")
title("Hazard-Rate Models", 
      line = -1, 
      outer = TRUE) # Naming title and setting location

# Comparing AIC of all the models 
summarize_ds_models(hn, hn_cos, hn_herm, hn_poly, 
                    hr, hr_cos, hr_herm, hr_poly,
                    output = "plain") # Plain output works instead of equations

# As the dataset is small, checking whether AICc is a more appropriate measure
# To do this, Takezawa (2014) has said AICc should be used when the ratio of your parameters
  # to number of data points is less than 1:40

summary(hr)
  # Parameters = 2 : Observations = 58
  # Therefore ratio is 1:29
    # This ratio will be even smaller for the models with adjustments 

summary(hn)
  # This is the only model that meets the assumptions of AIC however as you 
    # Can't compare across model selection parameters we will use AICc

# Using AICc to select models 
AICc(hn, hn_cos, hn_herm, hn_poly, 
     hr, hr_cos, hr_herm, hr_poly)

# Despite this there is no change in the best model

# The half-normal will be chosen as it has the smallest AIC and AICc
# No adjustment will be chosen as the adjustments don't model extra variability 
   # in the data 
```

```{r Model Fit, eval = FALSE}
#####     MODEL FIT     #####

# Comparing the detection function to the cramer-von mises test

# Setting plot size
par(mfrow=c(1,2), mar = c(5, 4, 4, 2) + 0.1)

# Plotting the detetion function over the distances distribution
plot(hn, 
     which=2, 
     pl.col = adjustcolor("seagreen",0.5), 
     border = NULL,
     ylab = "Detection probability (g(x))", 
     xlab = "Distance", 
     las=1,
     main = "Half-normal Model No Adjustments")

# Plotting and running the Cramer-von Mises test and bootstrap Kolmogorov-Smirnov      test for goodness-of-fit

gof_ds(hn, main = 'Expected vs Observed CDF' , ks = TRUE)

  # The Cramer-von Mises test gives a test statistic of 0.0732325 and a p-value of           0.731882
  # The Kolomogorov-Smirnov test gives a test statistic stat of 0.0725551 and a             p-value of 1

# Therefore the model has a good fit as the p values are much more than 0.05
```

```{r Model Inference, eval = FALSE}
#####     MODEL INFERENCE     #####
# Looking at model 
summary(hn)

# creating subsets of the column combinations needed for dht()
region_table <- unique(bowhead_LT[,c("Region.Label", 
                                     "Area")])

sample_table <- unique(bowhead_LT[,c("Region.Label", 
                                     "Sample.Label", 
                                     "Effort")])

observation_table <- unique(bowhead_LT[,c("object", 
                                          "Region.Label", 
                                          "Sample.Label")])

# Estimating bowhead whale abundance and density
abund_bio_hn <- dht(model = hn$ddf,
                    region_table, 
                    sample_table, 
                    observation_table)
```













